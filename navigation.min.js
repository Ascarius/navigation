(function(e,t){"use strict";function n(t,r){this.$element=e(t),this.options=e.extend({},n.DEFAULTS,r),this.options.baseUrl=this.options.baseUrl.replace(/\/$/,""),this.initialized=!1,this.reloaded=!1,this.states={},this.$contents={},this.$title=e("title"),e.address.state(this.options.baseUrl).init(e.proxy(this.init,this)).change(e.proxy(this.change,this))}if(e.address===t)return;n.DEFAULTS={baseUrl:"/",navSelector:"#menu a",navActiveClass:"active",updateNav:t,contents:{main:{selector:"#main",create:"append",update:"html",show:"fade",hide:"fade"}},debug:!1},e.extend(n.prototype,{log:function(){this.options.debug&&window.console&&console.log.apply(console,arguments)},init:function(n){var r=this;this.log("init"),r.$element.on("click",r.options.navSelector,function(n){var r=n.currentTarget;if(n.shiftKey||n.ctrlKey||n.metaKey||n.which==2)return!0;if(e(r).is("a")){var i=/address:/.test(e(r).attr("rel"))?e(r).attr("rel").split("address:")[1].split(" ")[0]:e.address.state()!==t&&!/^\/?$/.test(e.address.state())?e(r).attr("href").replace(new RegExp("^(.*"+e.address.state()+"|\\.)"),""):e(r).attr("href").replace(/^(#\!?|\.)/,"");n.preventDefault(),e.address.value(i)}}),r.$element.on("submit",r.options.navSelector,function(t){var n=t.currentTarget,r,i;e(n).is("form")&&(t.preventDefault(),r=e(n).attr("action"),i=(r.indexOf("?")!=-1?r.replace(/&$/,""):r+"?")+e(n).serialize(),e.address.value(i))})},change:function(t){var n=t.path;this.log("change",n),this.$element.trigger("change.navigation",t),this.initialized?this.reloaded?this.hasState(n)?this.handler(t):(this.log("load",n),this.$element.trigger("load.navigation",n),e.ajax({url:e.address.state()+n,dataType:"html",success:e.proxy(this.handler,this,t),error:e.proxy(this.error,this,t)})):(this.handler(t),this.reloaded=!0,this.log("reloaded",n)):(this.initialized=!0,this.log("initialized",n))},handler:function(e,t,n,r){var i=e.path;this.log("handle",i),t?this.saveContents(e.path,t):this.reloaded||this.saveContents(e.path,document),this.initialized&&this.reloaded&&(this.updateNav(i),this.updateContents(i)),r&&(this.log("loaded",i),this.$element.trigger("loaded.navigation",[i,t,n,r])),this.initialized&&(this.log("changed",i),this.$element.trigger("changed.navigation",[i,t,n,r]))},error:function(e,t,n,r){this.log("error",arguments),this.$element.trigger("error.navigation",[path,t,n,r])},updateNav:function(t,n){var r=this.options;if(!this.initialized)return;n=n||document,typeof r.updateNav=="function"?r.updateNav.call(e("a",n).filter(this.options.navSelector),r.baseUrl+t):e(r.navSelector,n).each(function(){var n=e(this);n.attr("href")==r.baseUrl+t?n.parent().addClass(r.navActiveClass):n.parent().removeClass(r.navActiveClass)})},saveContents:function(n,r){var i=this,s=this.options,o,u;this.log("save",n),r!==t&&((u=e("title",r).html())?this.setStateContent(n,"title",u):(u=r.match("<title>(.*)</title>"))&&this.setStateContent(n,"title",u[1]),e.each(s.contents,function(t,s){var o=typeof s=="string"?s:s.selector,u=i.getContentElement(t)||e(o),a=e(o,r);a.length?(u.length||(u=i._createContent(t,s,a)),i.hasContentElement(t)||i.setContentElement(t,u),i.setStateContent(n,t,a.html())):i.log(n+" has no "+t)}))},updateContents:function(t){var n=this,r=this.options,i;this.log("update",t),this.$title.html(this.getStateContent(t,"title")),e.each(r.contents,function(e,r){n.hasStateContent(t,e)?n._updateContent(t,e,r):n.hasContentElement(e)&&n._hideContent(t,e,r)})},_createContent:function(n,r,i){var s=this,o=r.create!==t?r.create:"append",u,a,f=function(){s.log("created",n),i.trigger("created.navigation")};if(o){this.log("create",n);if(typeof o=="function")o.call(i,n,r,f);else{a=i.parent(),a.length&&(a.attr("id")?u=e("#"+a.attr("id")):a.is("body")&&($currentContent=e("body")));if(u&&u.length)switch(o){case!0:case"append":u.append(i),f();break;case"prepend":u.prepend(i),f();break;default:throw new Error('Create method "'+o+'" is not valid')}else this.log("! no valid parent for "+n)}}return i},_updateContent:function(e,n,r){var i=this,s=r.update!==t?r.update:"html",o=this.getStateContent(e,n),u=this.getContentElement(n),a=function(){i.log("updated",n),i.updateNav(e,u),u.trigger("updated.navigation")};if(s){this.log("update",e,n);if(typeof s=="function")s.call(u,o,n,r,a);else switch(s){case!0:case"html":u.html(o),a();break;case"text":u.text(o),a();break;case"fade":u.fadeTo(400,0,function(){u.html(o),u.fadeTo(400,1,a)});break;case"prepend":u.prepend(o),a();break;case"append":u.append(o),a();break;default:throw new Error('update method "'+s+'" is not supported')}}this._showContent(n,r)},_showContent:function(e,n){var r=this,i=n.show!==t?n.show:"fade",s=this.getContentElement(e),o=function(){r.log("shown",e),s.trigger("shown.navigation")};if(!s)return;this.log("show",e),s.trigger("show.navigation");if(i)if(typeof i=="function")i.call(s,e,n,o);else switch(i){case!0:case"fade":s.fadeIn(o);break;case"show":s.show(),o();break;default:throw new Error('Show method "'+i+'" is not supported')}},_hideContent:function(e,n,r){var i=this,s=r.hide!==t?r.hide:"fade",o=this.getContentElement(n),u=function(){i.log("hidden",n),o.trigger("hidden.navigation")};if(!o)return;this.log("hide",n),o.trigger("hide.navigation");if(s)if(typeof s=="function")s.call(o,n,r,u);else switch(s){case!0:case"fade":o.fadeOut(u);break;case"hide":o.hide(),u();break;default:throw new Error('Hide method "'+s+'" is not supported')}},setState:function(e,t){return this.states[e]=t,this},getState:function(e){return this.states[e]},hasState:function(e){return this.states[e]!==t},setStateContent:function(e,n,r){return this.states[e]===t&&(this.states[e]={}),this.states[e][n]=r,this},getStateContent:function(e,n){return this.states[e]?this.states[e][n]:t},hasStateContent:function(e,n){return this.states[e]!==t&&this.states[e][n]!==t},setContentElement:function(e,t){return this.$contents[e]=t,this},getContentElement:function(e){return this.$contents[e]},hasContentElement:function(e){return this.$contents[e]!==t}}),e.fn.navigation=function(t){var r=e(this),i=r.data("wxr.navigation"),s=typeof t=="object"&&t;i||r.data("wxr.navigation",i=new n(this,s))},e.fn.navigation.noConflict=function(){return e.fn.navigation=old,this}})(window.jQuery);