(function(e,t){"use strict";function n(t){this.$window=e(window),this.$body=e(document.body),this.options=e.extend({},n.DEFAULTS,t),this.initialized=!1,this.states={},this.$contents={},this.$title=e("title"),e(e.proxy(this.init,this)),e(window).on("statechange",e.proxy(this.change,this))}if(!window.History||!History.enabled)throw new Error("History.js is required");n.DEFAULTS={navSelector:"#menu a",navActiveClass:"active",updateNav:t,contents:{main:{selector:"#main",create:"append",update:"fade",show:"fade",hide:"fade"}},debug:!1},e.extend(n.prototype,{log:function(){this.options.debug&&window.console&&console.log.apply(console,arguments)},init:function(){var t=this,n=History.getState(),r=n.url;t.log("init"),t.$body.on("click",t.options.navSelector,function(t){var n=e(t.currentTarget),r=n.prop("href"),i=n.prop("");if(t.shiftKey||t.ctrlKey||t.metaKey||t.which==2)return!0;n.is("a")&&(t.preventDefault(),History.pushState(null,null,r))}),this.handler(r),this.initialized=!0,this.log("initialized")},change:function(){var t=History.getState(),n=t.url;this.log("change"),this.$body.trigger("change.navigation",n),this.hasState(n)?this.handler(n):(this.log("load",n),this.$body.trigger("load.navigation",n),e.ajax({url:n,dataType:"html",success:e.proxy(this.handler,this,n),error:e.proxy(this.error,this,n)}))},handler:function(e,t,n,r){this.log("handle",e),t?this.saveContents(e,t):this.initialized||this.saveContents(e,document),this.initialized&&(this.updateNav(e),this.updateContents(e)),r&&(this.log("loaded",e),this.$body.trigger("loaded.navigation",[e,t,n,r])),this.initialized&&(this.log("changed",e),this.$body.trigger("changed.navigation",[e,t,n,r]))},error:function(e,t,n,r){this.log("error",arguments),this.$body.trigger("error.navigation",[e,t,n,r])},updateNav:function(n,r){var i=this.options,s;if(!this.initialized)return;r=r||t,s=r===t?e(this.options.navSelector):e("a",r).filter(this.options.navSelector),typeof i.updateNav=="function"?i.updateNav.call(s,n):s.each(function(){var t=e(this);t.attr("href")==n?t.parent().addClass(i.navActiveClass):t.parent().removeClass(i.navActiveClass)})},saveContents:function(n,r){var i=this,s=this.options,o,u;this.log("save",n),r!==t&&((u=e("title",r).html())?this.setStateContent(n,"title",u):(u=r.match("<title>(.*)</title>"))&&this.setStateContent(n,"title",u[1]),e.each(s.contents,function(t,s){var o=typeof s=="string"?s:s.selector,u=i.getContentElement(t)||e(o),a=e(o,r);a.length?(u.length||(u=i._createContent(t,s,a)),i._initContent(t,s,u),i.hasContentElement(t)||i.setContentElement(t,u),i.setStateContent(n,t,a.html())):i.log(n+" has no "+t)}))},updateContents:function(t){var n=this,r=this.options,i;this.log("update",t),this.$title.html(this.getStateContent(t,"title")),e.each(r.contents,function(e,r){n.hasStateContent(t,e)?n._updateContent(t,e,r):n.hasContentElement(e)&&n._hideContent(t,e,r)})},_createContent:function(n,r,i){var s=this,o=r.create!==t?r.create:"append",u,a,f=function(){s.log("created",n),i.trigger("created.navigation")};if(o){this.log("create",n);if(typeof o=="function")o.call(i,n,r,f);else{a=i.parent(),a.length&&(a.attr("id")?u=e("#"+a.attr("id")):a.is("body")&&($currentContent=e("body")));if(u&&u.length)switch(o){case!0:case"append":u.append(i),f();break;case"prepend":u.prepend(i),f();break;default:throw new Error('Create method "'+o+'" is not valid')}else this.log("! no valid parent for "+n)}}return i},_initContent:function(e,t,n){var r=this,i=function(){r.log("initialized",e),n.trigger("initialized.navigation")};typeof t.init=="function"&&(r.log("initialize",e),t.init.call(n,e,t,i))},_updateContent:function(e,n,r){var i=this,s=r.update!==t?r.update:"fade",o=this.getStateContent(e,n),u=this.getContentElement(n),a=function(){i.log("updated",n),i.updateNav(e,u),u.trigger("updated.navigation")};if(s){this.log("update",e,n);if(typeof s=="function")s.call(u,o,n,r,a);else switch(s){case!0:case"fade":u.fadeTo(400,0,function(){u.html(o),u.fadeTo(400,1,a)});break;case"html":u.html(o),a();break;case"text":u.text(o),a();break;case"prepend":u.prepend(o),a();break;case"append":u.append(o),a();break;default:throw new Error('update method "'+s+'" is not supported')}}this._showContent(n,r)},_showContent:function(e,n){var r=this,i=n.show!==t?n.show:"fade",s=this.getContentElement(e),o=function(){r.log("shown",e),s.trigger("shown.navigation")};if(!s)return;this.log("show",e),s.trigger("show.navigation");if(i)if(typeof i=="function")i.call(s,e,n,o);else switch(i){case!0:case"fade":s.fadeIn(o);break;case"show":s.show(),o();break;default:throw new Error('Show method "'+i+'" is not supported')}},_hideContent:function(e,n,r){var i=this,s=r.hide!==t?r.hide:"fade",o=this.getContentElement(n),u=function(){i.log("hidden",n),o.trigger("hidden.navigation")};if(!o)return;this.log("hide",n),o.trigger("hide.navigation");if(s)if(typeof s=="function")s.call(o,n,r,u);else switch(s){case!0:case"fade":o.fadeOut(u);break;case"hide":o.hide(),u();break;default:throw new Error('Hide method "'+s+'" is not supported')}},setState:function(e,t){return this.states[e]=t,this},getState:function(e){return this.states[e]},hasState:function(e){return this.states[e]!==t},setStateContent:function(e,n,r){return this.states[e]===t&&(this.states[e]={}),this.states[e][n]=r,this},getStateContent:function(e,n){return this.states[e]?this.states[e][n]:t},hasStateContent:function(e,n){return this.states[e]!==t&&this.states[e][n]!==t},setContentElement:function(e,t){return this.$contents[e]=t,this},getContentElement:function(e){return this.$contents[e]},hasContentElement:function(e){return this.$contents[e]!==t}});var r=e.navigation;e.navigation=function(t){var r=e(document.body),i=r.data("wxr.navigation"),s=typeof t=="object"&&t;i||r.data("wxr.navigation",i=new n(s))},e.navigation.noConflict=function(){return e.navigation=r,this}})(window.jQuery);